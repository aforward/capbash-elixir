#!/bin/bash
source ./bits/bootstrap/logging
set -euo pipefail ; IFS=$'\n\t'

#-----------
# Configurations
#-----------

ELIXIR_VERSION=${ELIXIR_VERSION-v1.0.0}
ELIXIR_MODE=${ELIXIR_MODE-docker}

LAUNCHER_OWNER=${LAUNCHER_OWNER-$USER}
export LAUNCHER_DIR=${LAUNCHER_DIR-/var/local}
export ELIXIR_LAUNCHER_DIR=${ELIXIR_LAUNCHER_DIR-$LAUNCHER_DIR/elixir/$ELIXIR_VERSION}

#-----------
# Install Script
#-----------

notify "Install Elixir ($ELIXIR_VERSION)..."

OWNER=$LAUNCHER_OWNER ./bits/bootstrap/mkdir LAUNCHER_DIR ELIXIR_LAUNCHER_DIR

if [[ "$ELIXIR_MODE" == "docker" ]]; then
  notify "  -- deploying via docker"
  cp ./bits/elixir/files/elixir.dockerfile ${ELIXIR_LAUNCHER_DIR}/Dockerfile
  cp ./bits/elixir/files/elixir.dockerignore ${ELIXIR_LAUNCHER_DIR}/.dockerignore
  sed -i s/@ELIXIR_VERSION@/$ELIXIR_VERSION/g ${ELIXIR_LAUNCHER_DIR}/Dockerfile

  LAUNCHER_DIR=$ELIXIR_LAUNCHER_DIR NAME=elixir_${ELIXIR_VERSION} ./bits/docker/build

  echo "docker run -i -t elixir_${ELIXIR_VERSION} /bin/bash" > ${ELIXIR_LAUNCHER_DIR}/debug
  chmod 755 ${ELIXIR_LAUNCHER_DIR}/debug

else
  notify "  -- deploying directly with bash"

  cp ./bits/elixir/files/elixir.bashfile ${ELIXIR_LAUNCHER_DIR}/Bashfile
  sed -i s/@ELIXIR_VERSION@/$ELIXIR_VERSION/g ${ELIXIR_LAUNCHER_DIR}/Bashfile
  chmod 755 ${ELIXIR_LAUNCHER_DIR}/Bashfile
  ${ELIXIR_LAUNCHER_DIR}/Bashfile

  echo "iex" > ${ELIXIR_LAUNCHER_DIR}/debug
  chmod 755 ${ELIXIR_LAUNCHER_DIR}/debug
fi

notify "DONE, Install Elixir."
#!/bin/bash
source ./bits/bootstrap/logging
set -euo pipefail ; IFS=$'\n\t'

#-----------
# Configurations
#-----------

ELIXIR_VERSION=${ELIXIR_VERSION-v1.0.0}
ELIXIR_MODE=${ELIXIR_MODE-docker}
ELIXIR_DISPLAY=${ELIXIR_DISPLAY-standalone} # or internal

LAUNCHER_OWNER=${LAUNCHER_OWNER-$USER}
export LAUNCHER_DIR=${LAUNCHER_DIR-/var/local}
export ELIXIR_LAUNCHER_DIR=${ELIXIR_LAUNCHER_DIR-$LAUNCHER_DIR/elixir/$ELIXIR_VERSION}

#-----------
# Install Script
#-----------

if [[ "$ELIXIR_DISPLAY" == "standalone" ]]; then
  notify "Install Elixir ($ELIXIR_VERSION)..."
else
  notify "  -- install Elixir ($ELIXIR_VERSION)..."
fi

OWNER=$LAUNCHER_OWNER ./bits/bootstrap/mkdir LAUNCHER_DIR ELIXIR_LAUNCHER_DIR $ELIXIR_LAUNCHER_DIR/src
TEMPLATE=./bits/elixir/files/src LOCATION=$ELIXIR_LAUNCHER_DIR/src ./bits/docker/copyallif

if [[ "$ELIXIR_MODE" == "docker" ]]; then
  notify "  -- deploying via docker"
  cp ./bits/elixir/files/elixir.dockerfile ${ELIXIR_LAUNCHER_DIR}/Dockerfile
  cp ./bits/elixir/files/elixir.dockerignore ${ELIXIR_LAUNCHER_DIR}/.dockerignore
  sed -i s/@ELIXIR_VERSION@/$ELIXIR_VERSION/g ${ELIXIR_LAUNCHER_DIR}/Dockerfile

  LAUNCHER_DIR=$ELIXIR_LAUNCHER_DIR NAME=elixir VERSION=${ELIXIR_VERSION} ./bits/docker/build

  NAME=elixir DIR=$ELIXIR_LAUNCHER_DIR BIT=elixir ./bits/docker/helpers

else
  notify "  -- deploying directly with bash"

  cp ./bits/elixir/files/elixir.bashfile ${ELIXIR_LAUNCHER_DIR}/Bashfile
  sed -i s/@ELIXIR_VERSION@/$ELIXIR_VERSION/g ${ELIXIR_LAUNCHER_DIR}/Bashfile
  chmod 755 ${ELIXIR_LAUNCHER_DIR}/Bashfile
  ${ELIXIR_LAUNCHER_DIR}/Bashfile

  echo "iex" > ${ELIXIR_LAUNCHER_DIR}/debug
  chmod 755 ${ELIXIR_LAUNCHER_DIR}/debug
fi

if [[ "$ELIXIR_DISPLAY" == "standalone" ]]; then
  notify "DONE, Install Elixir."
else
  notify "  -- DONE, Install Elixir."
fi
